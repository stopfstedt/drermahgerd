<?php
/**
 * @file
 * Unit tests for the Drermahgerd module.
 */

/**
 * Test case for the functionality in the Drermahgerd module.
 *
 * @see DrupalUnitTestCase
 * @ingroup drermahgerd
 */
class DrermahgerdTestCase extends DrupalUnitTestCase
{
  /**
   * @var Ermahgerd\Ermahgerd
   */
  protected $_e;

  /**
   * Gives display information to the SimpleTest system.
   *
   * @return array A keyed array of information for SimpleTest to show.
   */
  static public function getInfo()
  {
    return array(
      'name' => 'Drermahgerd Test',
      'description' => "Unit tests the Drermahgerd module's functionality.",
      'group' => 'Drermahgerd',
    );
  }

  /**
   * Set up the test environment.
   *
   * @see DrupalUnitTestCase::setUp()
   */
  public function setUp()
  {
    drupal_load('module', 'drermahgerd');
    $path = libraries_get_path('ermahgerd') . '/src/Ermahgerd/Ermahgerd.php';
    require_once $path;
    $this->_e = new Ermahgerd\Ermahgerd();
    parent::setUp();
  }

  /**
   * Calls <code>_drermahgerd_translate_markup()</code> and checks that it returns
   * the correct result.
   */
  public function testTranslateMarkup()
  {
    $text = '';
    $actual = _drermahgerd_translate_markup($this->_e, $text);
    $expected = '';
    $message = 'An empty string should return an empty string';
    $this->assertEqual($expected, $actual, $message);

    $text = '<p>this is a<em> test</em></p>';
    $actual = _drermahgerd_translate_markup($this->_e, $text, true);
    $expected = '<p>THERS ERS A<em> TERST</em></p>';
    $message = "The text in a given markup string should be properly translated, whilst maintaining the document's structure.";
    $this->assertEqual($expected, $actual, $message);
  }

  /**
   * Calls <code>_drermahgerd_translate_plain()</code> and checks that it returns
   * the correct result.
   */
  public function testTranslatePlaintext()
  {
    $text = '';
    $actual = _drermahgerd_translate_plain($this->_e, $text, true);
    $expected = '';
    $message = 'An empty string should return an empty string';
    $this->assertEqual($expected, $actual, $message);

    $text = 'this is a test';
    $actual = _drermahgerd_translate_plain($this->_e, $text);
    $expected = 'THERS ERS A TERST';
    $message = 'An given plaintext string should be properly translated.';

    $this->assertEqual($expected, $actual, $message);
  }

  /**
   * Calls <code>_drermahgerd_generate_cache_key()</code> and checks that it returns
   * the correct result.
   */
  public function testCacheKeyGeneration()
  {
    $content  = 'this is a test';
    $keyPlain = _drermahgerd_generate_cache_key($content, 'plain');
    $keyMarkup = _drermahgerd_generate_cache_key($content, 'markup');

    // test the key generation algorithm.
    $expectedKeyPlain = 'drermahgerd_content_plain_' . md5($content);
    $expectedKeyMarkup = 'drermahgerd_content_markup_' . md5($content);

    $message = 'A cache key should be properly created from the given content.';

    $this->assertEqual($expectedKeyPlain, $keyPlain, $message);
    $this->assertEqual($expectedKeyMarkup, $keyMarkup, $message);
  }
}


